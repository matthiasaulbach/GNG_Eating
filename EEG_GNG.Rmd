---
title: "Analysis for _N2 in Food-Go/No-Go training_"
output:
  html_document:
    code_folding: hide
    number_sections: yes
    df_print: paged
    toc: yes
    toc_float: true
  pdf_document:
    number_sections: yes
    toc: yes
---

```{r setup, include=FALSE, error=FALSE, warning=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, error=FALSE, warning=FALSE)
pacman::p_load(tidyverse, rprime, wrapr, ggplot2, xlsx, emmeans, lmerTest, afex, apa, stargazer, apaTables, sjPlot, lsr)
options(scipen=999)
test_dats_raw <- readRDS("E-Prime data/raw_RT_data.rds")
```

In this document, I supply some information about the data distribution that is not in the manuscript, the most important data wrangling code, the analyses underlying the content of the paper, and some additional analyses that go beyond what was reported there. All of the code can of course be adjusted to conduct additional analyses of interest.

```{r outlier removal RT, echo=FALSE}
test_dats_trim <- test_dats_raw %>% 
  dplyr::select(-c(2:15), -BMI) %>%
  subset(!is.na(Stim.RT))
test_dats_trim$Subject <- as.numeric(test_dats_trim$Subject)
test_dats_trim$Running <- as.factor(test_dats_trim$Running)

test_dats_trim$accuracy <- ifelse(test_dats_trim$commission == 1 | 
                                          test_dats_trim$ommission == 1, 0, 1)


# Converting test_dats_trim to a data.frame object since sdTrim apparently can only handle that class of object

test_dats_trim <- as.data.frame(test_dats_trim)

# This removes outliers per condition, i.e. within balanced, HighCalGo, and LowCalGo blocks, respectively
## It ALSO removes error trials since I included minRT = 150 (and error trials have "0" reaction time). 
## Note that "minRT" removes the RTs below the threshold BEFORE doing the SD trimming.
test_dats <- trimr::sdTrim(data = subset(test_dats_trim, 
                                  (test_dats_trim$GOorNO == "GO") & 
                                    (!is.na(test_dats_trim$Stim.RT)) & 
                                    (Running == "TrialListTestBalanced" |
                                       Running == "TrialListHighCalGo" |
                                       Running == "TrialListLowCalGo")), condVar = "Running", pptVar = "Subject", rtVar = "Stim.RT",
                              perCondition = TRUE, perParticipant = TRUE,
                               minRT = 150, sd = 3, returnType = "raw", digits = 0)
test_dats$Prime <- test_dats$Prime %>%
  gsub(pattern = "img/FOOD/0", replacement = "") %>%
  as.factor
## Note that "test_dats" now holds GO trials only!
```

```{r data wrangling, echo=FALSE}
## RT grouped by Subject, Primetype, Block (Assessment, HighCalGo, LowCalGo), and Cycle
RT_by_subject <- subset(test_dats, (Primetype == "HighGo" | Primetype == "LowGo" | Primetype == "DistGo")) %>% 
  filter(!is.na(Stim.RT)) %>% 
  filter(Running != "TrialListTrain") %>%
  group_by(Subject, Primetype, Running, Cycle) %>%
  dplyr::summarize(meanRT = mean(Stim.RT, na.rm = TRUE), sdRT = sd(Stim.RT, na.rm = TRUE))
## Let's make RT_by_subject tidy
RT_tidy <- RT_by_subject %>%
  dplyr::select(-sdRT) %>%
  unite(Prime_Running, Primetype, Running) %>%
  unite(Prime_Running_Cycle, Prime_Running, Cycle) %>%
  spread(key = Prime_Running_Cycle, value = meanRT)
## Need to put age etc. back into the dataframe
RT_tidy$Age <- as.numeric(subset(test_dats_raw$Age, !is.na(test_dats_raw$Age)))
RT_tidy$Sex <- subset(test_dats_raw$Sex, !is.na(test_dats_raw$Sex))
RT_tidy$Handedness <- subset(test_dats_raw$Handedness, !is.na(test_dats_raw$Handedness))
RT_tidy$Height <- subset(test_dats_raw$Height, !is.na(test_dats_raw$Height))
RT_tidy$Weight <- subset(test_dats_raw$Weight, !is.na(test_dats_raw$Weight))
RT_tidy$BMI <- subset(test_dats_raw$BMI, !is.na(test_dats_raw$BMI))

###### Read in all the other data
food_hunger_lasteaten <- readRDS("./diaries/food_hunger_lasteaten.rds")
###### And the ERP data:
ERP_tidy <- readRDS("ERP_tidy_individual_averages.rds")

# Putting the data frames together
diaries_weekdays <- read.table("./diaries/diaries_weekdays.txt", header = TRUE, sep = "\t")
full_dat <- full_join(food_hunger_lasteaten, RT_tidy, by = "Subject")
# We have to exclude participant number 12 as that EEG data is not usable
full_dat <- subset(full_dat, Subject != 12)
ERP_tidy$Subject <- as.numeric(ERP_tidy$pp)


# The final tidy data frame: full_withERP!
full_withERP <- full_join(full_dat, ERP_tidy, by = "Subject")


# adding the "Order" variable
## need to make "Subject" numeric
full_withERP$Subject <- as.numeric(full_withERP$Subject)
full_withERP$Order <- ifelse((full_withERP$Subject %% 2) == 0, "LowCalGofirst", "HighCalGofirst")
full_withERP$Subject <- as.factor(full_withERP$Subject)
# Also adding a variable indicating total in-lab food intake
full_withERP$total_in_lab <- full_withERP$consumed_T1 + full_withERP$consumed_T2

# What follows are Reaction Time variables
## Let's rename those columns
full_withERP <- plyr::rename(full_withERP, c("HighGo_TrialListHighCalGo_1"="High_HighGo_1", 
                         "HighGo_TrialListHighCalGo_2"="High_HighGo_2",
                         "HighGo_TrialListHighCalGo_3"="High_HighGo_3",
                         "HighGo_TrialListHighCalGo_4"="High_HighGo_4",
                         "HighGo_TrialListLowCalGo_1"="High_LowGo_1",
                         "HighGo_TrialListLowCalGo_2"="High_LowGo_2",
                         "HighGo_TrialListLowCalGo_3"="High_LowGo_3",
                         "HighGo_TrialListLowCalGo_4"="High_LowGo_4",
                         "HighGo_TrialListTestBalanced_1"="High_Balanced_1",
                         "HighGo_TrialListTestBalanced_2"="High_Balanced_2",
                         "HighGo_TrialListTestBalanced_3"="High_Balanced_3",
                         "HighGo_TrialListTestBalanced_4"="High_Balanced_4",
                         "LowGo_TrialListHighCalGo_1"="Low_HighGo_1", 
                         "LowGo_TrialListHighCalGo_2"="Low_HighGo_2",
                         "LowGo_TrialListHighCalGo_3"="Low_HighGo_3",
                         "LowGo_TrialListHighCalGo_4"="Low_HighGo_4",
                         "LowGo_TrialListLowCalGo_1"="Low_LowGo_1",
                         "LowGo_TrialListLowCalGo_2"="Low_LowGo_2",
                         "LowGo_TrialListLowCalGo_3"="Low_LowGo_3",
                         "LowGo_TrialListLowCalGo_4"="Low_LowGo_4",
                         "LowGo_TrialListTestBalanced_1"="Low_Balanced_1",
                         "LowGo_TrialListTestBalanced_2"="Low_Balanced_2",
                         "LowGo_TrialListTestBalanced_3"="Low_Balanced_3",
                         "LowGo_TrialListTestBalanced_4"="Low_Balanced_4",
                         "DistGo_TrialListHighCalGo_1"="Dist_HighGo_1", 
                         "DistGo_TrialListHighCalGo_2"="Dist_HighGo_2",
                         "DistGo_TrialListHighCalGo_3"="Dist_HighGo_3",
                         "DistGo_TrialListHighCalGo_4"="Dist_HighGo_4",
                         "DistGo_TrialListLowCalGo_1"="Dist_LowGo_1",
                         "DistGo_TrialListLowCalGo_2"="Dist_LowGo_2",
                         "DistGo_TrialListLowCalGo_3"="Dist_LowGo_3",
                         "DistGo_TrialListLowCalGo_4"="Dist_LowGo_4",
                         "DistGo_TrialListTestBalanced_1"="Dist_Balanced_1",
                         "DistGo_TrialListTestBalanced_2"="Dist_Balanced_2",
                         "DistGo_TrialListTestBalanced_3"="Dist_Balanced_3",
                         "DistGo_TrialListTestBalanced_4"="Dist_Balanced_4"))

# Creating baseline RT bias variable
full_withERP$baseline_high_go <- (full_withERP$High_Balanced_1 + full_withERP$High_Balanced_2 +
                                full_withERP$High_Balanced_3 + full_withERP$High_Balanced_4)/4
full_withERP$baseline_low_go <- (full_withERP$Low_Balanced_1 + full_withERP$Low_Balanced_2 +
                                full_withERP$Low_Balanced_3 + full_withERP$Low_Balanced_4)/4
full_withERP$baseline_RTbias <- full_withERP$baseline_high_go - full_withERP$baseline_low_go

# Calculating the RT training block bias
full_withERP$high_bias_high_go <- (full_withERP$High_HighGo_1 + full_withERP$High_HighGo_2 +
                                full_withERP$High_HighGo_3 + full_withERP$High_HighGo_4)/4
full_withERP$low_bias_low_go <- (full_withERP$Low_LowGo_1 + full_withERP$Low_LowGo_2 +
                                full_withERP$Low_LowGo_3 + full_withERP$Low_LowGo_4)/4
full_withERP$training_RTbias <- full_withERP$high_bias_high_go - full_withERP$low_bias_low_go

# Difference between time points in food intake
full_withERP$lab_food_diff <- full_withERP$after_High_Cal_Go - full_withERP$after_Low_Cal_Go

# Creating a mean score for hunger etc.
## Inverting the "full"-item
full_withERP$full_inv <- car::recode(full_withERP$Full.RESP, '1=7; 2=6; 3=5; 4=4; 5=3; 6=2; 7=1')
## taking the mean of all thos variables
full_withERP$overall_hunger <- rowMeans(full_withERP[c("full_inv", "Hungry.RESP" ,"Desire.RESP", "Urge.RESP", "Preoccupation.RESP")], na.rm = TRUE)

# Creating the baseline difference scores for ERP
## since there are two values for each electrode and trial type (the two cycles), I average across those
full_withERP <- full_withERP %>%
  mutate(BaselineDiff_Cz = 
           (((High_No.1.Balanced.Cz + High_No.2.Balanced.Cz)/2) - ((High_Go.1.Balanced.Cz + High_Go.2.Balanced.Cz)/2)) -
           (((Low_No.1.Balanced.Cz + Low_No.2.Balanced.Cz)/2) - ((Low_Go.1.Balanced.Cz + Low_Go.2.Balanced.Cz)/2)),
         BaselineDiff_FC1 = 
           (((High_No.1.Balanced.FC1 + High_No.2.Balanced.FC1)/2) - ((High_Go.1.Balanced.FC1 + High_Go.2.Balanced.FC1)/2)) -
           (((Low_No.1.Balanced.FC1 + Low_No.2.Balanced.FC1)/2) - ((Low_Go.1.Balanced.FC1 + Low_Go.2.Balanced.FC1)/2)),
         BaselineDiff_FC2 = 
           (((High_No.1.Balanced.FC2 + High_No.2.Balanced.FC2)/2) - ((High_Go.1.Balanced.FC2 + High_Go.2.Balanced.FC2)/2)) -
           (((Low_No.1.Balanced.FC2 + Low_No.2.Balanced.FC2)/2) - ((Low_Go.1.Balanced.FC2 + Low_Go.2.Balanced.FC2)/2)),
         BaselineDiff_Fz = 
           (((High_No.1.Balanced.Fz + High_No.2.Balanced.Fz)/2) - ((High_Go.1.Balanced.Fz + High_Go.2.Balanced.Fz)/2)) -
           (((Low_No.1.Balanced.Fz + Low_No.2.Balanced.Fz)/2) - ((Low_Go.1.Balanced.Fz + Low_Go.2.Balanced.Fz)/2)),
         BaselineDiff_allsites = 
           ((HighNo.Balanced.allsites - HighGo.Balanced.allsites) - (LowNo.Balanced.allsites - LowGo.Balanced.allsites))
  )

# And let's make the data frame long for future use
ERP_long <- full_withERP %>%
  dplyr::select(., - c("Subject":"Daily_intake")) %>%
  mutate(High_No_Balanced_Cz = ((High_No.1.Balanced.Cz + High_No.2.Balanced.Cz)/2),
         High_Go_Balanced_Cz = ((High_Go.1.Balanced.Cz + High_Go.2.Balanced.Cz)/2),
         Low_No_Balanced_Cz = ((Low_No.1.Balanced.Cz + Low_No.2.Balanced.Cz)/2),
         Low_Go_Balanced_Cz = ((Low_Go.1.Balanced.Cz + Low_Go.2.Balanced.Cz)/2),
         High_No_HighCalGo_Cz = ((High_No.1.HighCalGo.Cz + High_No.2.HighCalGo.Cz)/2),
         High_Go_HighCalGo_Cz = ((High_Go.1.HighCalGo.Cz + High_Go.2.HighCalGo.Cz)/2),
         Low_No_HighCalGo_Cz = ((Low_No.1.HighCalGo.Cz + Low_No.2.HighCalGo.Cz)/2),
         Low_Go_HighCalGo_Cz = ((Low_Go.1.HighCalGo.Cz + Low_Go.2.HighCalGo.Cz)/2),
         High_No_LowCalGo_Cz = ((High_No.1.LowCalGo.Cz + High_No.2.LowCalGo.Cz)/2),
         High_Go_LowCalGo_Cz = ((High_Go.1.LowCalGo.Cz + High_Go.2.LowCalGo.Cz)/2),
         Low_No_LowCalGo_Cz = ((Low_No.1.LowCalGo.Cz + Low_No.2.LowCalGo.Cz)/2),
         Low_Go_LowCalGo_Cz = ((Low_Go.1.LowCalGo.Cz + Low_Go.2.LowCalGo.Cz)/2),
         High_No_Balanced_FC1 = ((High_No.1.Balanced.FC1 + High_No.2.Balanced.FC1)/2),
         High_Go_Balanced_FC1 = ((High_Go.1.Balanced.FC1 + High_Go.2.Balanced.FC1)/2),
         Low_No_Balanced_FC1 = ((Low_No.1.Balanced.FC1 + Low_No.2.Balanced.FC1)/2),
         Low_Go_Balanced_FC1 = ((Low_Go.1.Balanced.FC1 + Low_Go.2.Balanced.FC1)/2),
         High_No_HighCalGo_FC1 = ((High_No.1.HighCalGo.FC1 + High_No.2.HighCalGo.FC1)/2),
         High_Go_HighCalGo_FC1 = ((High_Go.1.HighCalGo.FC1 + High_Go.2.HighCalGo.FC1)/2),
         Low_No_HighCalGo_FC1 = ((Low_No.1.HighCalGo.FC1 + Low_No.2.HighCalGo.FC1)/2),
         Low_Go_HighCalGo_FC1 = ((Low_Go.1.HighCalGo.FC1 + Low_Go.2.HighCalGo.FC1)/2),
         High_No_LowCalGo_FC1 = ((High_No.1.LowCalGo.FC1 + High_No.2.LowCalGo.FC1)/2),
         High_Go_LowCalGo_FC1 = ((High_Go.1.LowCalGo.FC1 + High_Go.2.LowCalGo.FC1)/2),
         Low_No_LowCalGo_FC1 = ((Low_No.1.LowCalGo.FC1 + Low_No.2.LowCalGo.FC1)/2),
         Low_Go_LowCalGo_FC1 = ((Low_Go.1.LowCalGo.FC1 + Low_Go.2.LowCalGo.FC1)/2),
         High_No_Balanced_FC2 = ((High_No.1.Balanced.FC2 + High_No.2.Balanced.FC2)/2),
         High_Go_Balanced_FC2 = ((High_Go.1.Balanced.FC2 + High_Go.2.Balanced.FC2)/2),
         Low_No_Balanced_FC2 = ((Low_No.1.Balanced.FC2 + Low_No.2.Balanced.FC2)/2),
         Low_Go_Balanced_FC2 = ((Low_Go.1.Balanced.FC2 + Low_Go.2.Balanced.FC2)/2),
         High_No_HighCalGo_FC2 = ((High_No.1.HighCalGo.FC2 + High_No.2.HighCalGo.FC2)/2),
         High_Go_HighCalGo_FC2 = ((High_Go.1.HighCalGo.FC2 + High_Go.2.HighCalGo.FC2)/2),
         Low_No_HighCalGo_FC2 = ((Low_No.1.HighCalGo.FC2 + Low_No.2.HighCalGo.FC2)/2),
         Low_Go_HighCalGo_FC2 = ((Low_Go.1.HighCalGo.FC2 + Low_Go.2.HighCalGo.FC2)/2),
         High_No_LowCalGo_FC2 = ((High_No.1.LowCalGo.FC2 + High_No.2.LowCalGo.FC2)/2),
         High_Go_LowCalGo_FC2 = ((High_Go.1.LowCalGo.FC2 + High_Go.2.LowCalGo.FC2)/2),
         Low_No_LowCalGo_FC2 = ((Low_No.1.LowCalGo.FC2 + Low_No.2.LowCalGo.FC2)/2),
         Low_Go_LowCalGo_FC2 = ((Low_Go.1.LowCalGo.FC2 + Low_Go.2.LowCalGo.FC2)/2),
         High_No_Balanced_Fz = ((High_No.1.Balanced.Fz + High_No.2.Balanced.Fz)/2),
         High_Go_Balanced_Fz = ((High_Go.1.Balanced.Fz + High_Go.2.Balanced.Fz)/2),
         Low_No_Balanced_Fz = ((Low_No.1.Balanced.Fz + Low_No.2.Balanced.Fz)/2),
         Low_Go_Balanced_Fz = ((Low_Go.1.Balanced.Fz + Low_Go.2.Balanced.Fz)/2),
         High_No_HighCalGo_Fz = ((High_No.1.HighCalGo.Fz + High_No.2.HighCalGo.Fz)/2),
         High_Go_HighCalGo_Fz = ((High_Go.1.HighCalGo.Fz + High_Go.2.HighCalGo.Fz)/2),
         Low_No_HighCalGo_Fz = ((Low_No.1.HighCalGo.Fz + Low_No.2.HighCalGo.Fz)/2),
         Low_Go_HighCalGo_Fz = ((Low_Go.1.HighCalGo.Fz + Low_Go.2.HighCalGo.Fz)/2),
         High_No_LowCalGo_Fz = ((High_No.1.LowCalGo.Fz + High_No.2.LowCalGo.Fz)/2),
         High_Go_LowCalGo_Fz = ((High_Go.1.LowCalGo.Fz + High_Go.2.LowCalGo.Fz)/2),
         Low_No_LowCalGo_Fz = ((Low_No.1.LowCalGo.Fz + Low_No.2.LowCalGo.Fz)/2),
         Low_Go_LowCalGo_Fz = ((Low_Go.1.LowCalGo.Fz + Low_Go.2.LowCalGo.Fz)/2)) %>%
  dplyr::select(-c(High_Go.1.Balanced.Cz:Low_No.2.LowCalGo.Fz)) %>%
  gather("Variable", "Value", High_No_Balanced_Cz:Low_Go_LowCalGo_Fz) %>%
  separate(Variable, c("HighLow", "GoNo", "Block", "Electrode"))

# Checking outliers in the food diary intake
# Outlier participants (defined as 3 sd above or below average)
## Food diary intake
full_withERP$Daily_intake_outlier <- 
  ifelse(full_withERP$Daily_intake > (mean(full_withERP$Daily_intake, na.rm = TRUE) + 3*sd(full_withERP$Daily_intake, na.rm = TRUE)) |
           full_withERP$Daily_intake < (mean(full_withERP$Daily_intake, na.rm = TRUE) - 3*sd(full_withERP$Daily_intake, na.rm = TRUE)),
         1, 0)
```


# Descriptive statistics

Let's start with some statistics describing our sample:

<style>

table, td, th {
  border: none;
  padding-left: 1em;
  padding-right: 1em;
  min-width: 50%;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1em;
  margin-bottom: 1em;
}

</style>

```{r descriptives1, results='asis', echo = FALSE}
as.data.frame(full_withERP) %>%
  dplyr::select(Age,
                LastEaten,
                Daily_intake,
                Weight,
                Height,
                BMI, 
                Hungry.RESP, 
                Full.RESP, 
                Desire.RESP, 
                HowMuch.RESP, 
                Urge.RESP, 
                Preoccupation.RESP, 
                overall_hunger) %>%
  stargazer::stargazer(., type = "html", summary.stat = c("mean", "sd", "min", "max"), digits = 2)
```

And here are the means and standard deviations in the ERP amplitudes for the different trial types in different blocks and parts of the blocks:

```{r descriptives2, results = "asis"}
full_withERP %>%
  dplyr::select(HighGo_1_Balanced.allsites:LowNo_2_LowCalGo.allsites) %>%
  stargazer::stargazer(., type = "html", summary.stat = c("mean", "sd", "min", "max"), digits = 2, title = "Mean ERP values in the different parts of the experiment")
```

# Hypothesis tests

_Note_: the order of the hypotheses follows the manuscript, not the pre-registration.

## Hypothesis 1: N2 by food image type and Go vs No-Go

So here's the test for the first hypothesis about the interaction between stimulus type and trial type in the balanced block.

```{r}
# Let's test our first hypothesis about the interaction between stimulus type and trial type in the balanced block
aov_hypothesis1 <- aov_car(Value ~ HighLow*GoNo + Error(pp/HighLow*GoNo),
        data=subset(ERP_long, Block == "Balanced"), anova_table = list(es = "pes"))

knitr::kable(nice(aov_hypothesis1))

apaTables::apa.2way.table(HighLow, GoNo, Value,
                          show.marginal.means = TRUE,
                          subset(ERP_long, Block == "Balanced"))

plot_hypothesis1 <- afex::afex_plot(aov_hypothesis1, 
                x = "HighLow", 
                trace = "GoNo",
                error="within",
                data_alpha = 0,
                data_arg = list(size = 1),
                mapping = c("color"),
                point_arg = list(size = 3), 
                error_arg = list(size = 1, width = 0.2),legend_title = "Trial type",
                factor_levels = (list(GoNo = c("No-Go", "Go")))) +
                   labs(x = "Calorie content", 
                        y = "N2",
                        title = "Baseline N2 amplitudes by calorie content and trial type") + 
   scale_fill_discrete(name = "Dose") +
   ylim(-6.5, -2.5) +
   scale_color_manual(values = c("#D55E00", "#009E73")) +
   theme_minimal()
  
plot_hypothesis1
```

So we have a significant effect of Go/No-Go but, against our hypothesis, no interaction. The difference between Go and No-Go trials is similar for high- and low-calorie foods.

In addition to the plot in the manuscript, I add here a graph with all the individual mean values.

```{r hypothesis1ind}
plot_hypothesis1_ind <- afex::afex_plot(aov_hypothesis1, 
                x = "HighLow", 
                trace = "GoNo",
                error="within",
                data_alpha = 0.5,
                data_arg = list(size = 1),
                mapping = c("color"),
                point_arg = list(size = 3), 
                error_arg = list(size = 1, width = 0.2),legend_title = "Trial type",
                factor_levels = (list(GoNo = c("No-Go", "Go")))) +
                   labs(x = "Calorie content", 
                        y = "N2",
                        title = "Baseline N2 amplitudes by calorie content and trial type") + 
   scale_fill_discrete(name = "Dose") +
   scale_color_manual(values = c("#D55E00", "#009E73")) +
   theme_minimal()

plot_hypothesis1_ind
```

## Hypothesis 2: Food intake outcomes.

Our hypothesis was that participants would eat less candy after performing a _High-Calorie-No-Go_ - task because they have learned to stop to those high-calorie foods. However. we see _higher_ food consumption after the _High-Calorie-No-Go_ condition. Obviously, the t-test shows that there is no significant difference in the predicted direction.

```{r hypothesis2}
# Let's look at some of the food intake outcomes
## Lab intake
full_withERP %>% 
  select(after_High_Cal_Go, after_Low_Cal_Go) %>%
  gather(., "Block", "Intake", after_High_Cal_Go:after_Low_Cal_Go) %>%
  group_by(Block) %>%
  summarise_at(vars(Intake), funs(mean, sd))
### Descriptively, participants ate MORE after Low_Cal_Go (against the hypothesis!)
### Let's run a t-test on that
t.test(full_withERP$after_High_Cal_Go, full_withERP$after_Low_Cal_Go, paired = TRUE, alternative = "greater")
## No significant difference between consumption after HighCalGo vs LowCalGo
```

## Hypothesis 3: Predicting food intake with N2 differences

To test hypothesis 3: predicting food intake with baseline difference scores: (HighCalorie-NoGo - HighCalorieGo) - (LowCalorie-NoGo - LowCalorieGo). Note that in these analyses, we removed one outlier participant who indicated unrealistically high amounts of calories consumed in the food diary and four participants returned no food diary so are not included in the analysis for that outcome.


```{r hypothesis3, results = "asis"}
## Using the average across electrode sites to predict food intake
full_withERP <- full_withERP %>% 
  rowwise() %>%
  mutate(., ERPBaselineDiff_allsites = mean(c(BaselineDiff_Cz, BaselineDiff_FC1, BaselineDiff_FC2, BaselineDiff_Fz)))
## Regression for diary intake
regression_daily <- lm(Daily_intake ~ ERPBaselineDiff_allsites + as.numeric(Age) + Sex + BMI + overall_hunger, data = subset(full_withERP, Daily_intake_outlier == "0"))
## And for lab food intake
regression_labfood <- lm(total_in_lab ~ ERPBaselineDiff_allsites + as.numeric(Age) + Sex + BMI + overall_hunger, data = full_withERP)

stargazer::stargazer(regression_daily, regression_labfood, type = "html", star.cutoffs = c(0.05, 0.01, 0.001), report = "vc*sp")
```

As reported in the manuscript, we found no significant connection between this baseline difference score and food intake.

## Hypothesis 4: Training effects on N2

The hypothesis is that N2 difference scores become more pronounced with training, i.e. the values are more extreme in Cycle 2 than Cycle 1 and that this change is more pronounced for high calorie food (i.e. an interaction between differences with type of food). (As a reminder, this difference score is calculated as e.g. LowCalGo_DiffCz_1 = High_No.1.LowCalGo.Cz - Low_Go.1.LowCalGo.Cz, i.e. within Blocks and Cycles)

```{r hypothesis4}
ERP_anova_change <- full_withERP %>%
  dplyr::select(pp, LowCalGo_DiffCz_1:HighCalGo_DiffFz_2) %>%
  gather("Block.electrode.Cycle", "difference.score", LowCalGo_DiffCz_1:HighCalGo_DiffFz_2) %>%
  separate(col = Block.electrode.Cycle, into = c("Block", "Electrode", "Cycle"), sep = "_")
ERP_anova_change$Electrode = gsub(ERP_anova_change$Electrode, pattern = "Diff", replacement = "")

aov_hypothesis5 <- aov_car(difference.score ~ Block*Cycle + Error(pp/Block*Cycle), 
        data=ERP_anova_change, anova_table = list(es = "pes"))

apaTables::apa.2way.table(Block, Cycle, difference.score, 
                          show.marginal.means = TRUE,
                          ERP_anova_change)



difference_scores_plot <- afex::afex_plot(
  aov_hypothesis5, 
                x = "Cycle", 
                trace = "Block",
                error="within",
                data_alpha = 0, # making the raw data points transparent
                mapping = c("color"),
                point_arg = list(size = 3), 
                error_arg = list(size = 1, width = 0.2),
                factor_levels = (list(Block = c("High-Calorie-No-Go", "Low-Calorie-No-Go"),
                                       Cycle = c("T1", "T2")))) +
                  labs(y = "N2 difference scores within Block (NoGo-Go)",
                       x = "Timepoint") +
  ylim(-3, 0) +
  ggtitle("N2-difference score by Block and Cycle in the Biased Blocks") +
  scale_color_manual(values = c("#009E73", "#D55E00"))  +
  theme_minimal()

difference_scores_plot
```

Also for this analysis I provide an additional plot to get a better idea of the data. 

```{r hypothesis4_supp}
Bias_Cycles <- full_withERP %>%
  dplyr::select(pp,
         HighGo_1_HighCalGo.allsites, HighGo_2_HighCalGo.allsites,
         HighNo_1_LowCalGo.allsites, HighNo_2_LowCalGo.allsites,
         LowGo_1_LowCalGo.allsites, LowGo_2_LowCalGo.allsites,
         LowNo_1_HighCalGo.allsites, LowNo_2_HighCalGo.allsites) %>%
  gather("Trial_Cycle_Block", "N2", HighGo_1_HighCalGo.allsites:LowNo_2_HighCalGo.allsites) %>%
  separate(col = Trial_Cycle_Block, into = c("Trial", "Timepoint", "Block"), sep = "_") %>%
  separate(col = "Trial", into = c("HighLow", "GoNo"), sep = -2, remove = FALSE) %>%
  mutate(Block = as.factor(Block)) %>%
  mutate(Block = recode(Block, HighCalGo.allsites = "Low-Calorie-No-Go", LowCalGo.allsites = "High-Calorie-No-Go")) %>%
  group_by(HighLow, GoNo, Timepoint)

aov_Biased_Blocks_Cycles <- aov_car(N2 ~ Block*GoNo*Timepoint + Error(pp/Block*GoNo*Timepoint),
        data = Bias_Cycles)

training_blocks_plot <- afex::afex_plot(aov_Biased_Blocks_Cycles, 
                x = "Timepoint", 
                trace = "GoNo", 
                panel = "Block", 
                error="within", 
                data_alpha = 0.5, 
                mapping = c("color"),
                point_arg = list(size = 2.5),
                error_arg = list(size = 1, width = 0.2),
                legend_title = "Trial type",
                factor_levels = (list(GoNo = c("Go", "No-Go"),
                                       Timepoint = c("T1", "T2"),
                                      Block = c("Low-Calorie-No-Go", "High-Calorie-No-Go"))))  +
                  labs(y = "N2",
                       title = "N2 amplitudes for Go- and No-Go trials in the training blocks") + 
  scale_fill_discrete(name = "Dose") +
  scale_color_manual(values = c("#009E73", "#D55E00")) +
  theme_minimal()

training_blocks_plot
```

Here we have the respective N2-amplitudes for Go- vs No-Go- and high- vs- low calorie trials in the two training blocks throughout the two timepoints. So in comparison with the last plot, this one shows the values for the actual kinds of trials instead of difference scores.


# Additional analyses

## Behavioral data

The pre-registration mentions analyses of reaction times which we dropped to make the manuscript more stringent. For the interested reader, we here present those analyses and some illustrative graphs about reaction time data.

### Describing the RT data

This graph shows mean reaction times in the different blocks and divided into the 4 repetitions within the blocks. The small dots indicate individual means within the block and the larger ones are the overall means. RTs to high-calorie images are in green, low-calorie pictures in blue, and distractors in red. Note that in the bias blocks, there are dominant and rare trials, i.e. only few High-Calorie-Go-trials in the High-Calorie-No-Go block and vice versa. We see that reaction times are very similar across the different kinds of stimuli. Participants get faster in the biased blocks, apparently also to the rare Go-trials. Also, reactions to distractors are a bit slower (note that, unlike the food pictures, they are not predictive of Go or No-Go in any block).

```{r visualize RT}
### Let's visualize some of this
by_block_cycle <- full_withERP %>%
  dplyr::select(Subject,
         Dist_HighGo_1:Low_Balanced_4,
         Order) %>%
  gather(Block, RT, -c(Subject, Order)) %>%
  separate(Block, c("HighLowDist", "Part", "Cycle"))

by_block_cycle_means <- by_block_cycle %>%
  group_by(HighLowDist, Part, Cycle) %>%
  summarise(RT = mean(RT))

by_block_cycle %>%
  group_by(HighLowDist, Part, Cycle) %>%
  summarise_at(., vars(RT), funs(mean, sd))

ggplot(by_block_cycle, aes(x = Cycle, y = RT, color = HighLowDist)) +
  geom_point(alpha = .3) +
  facet_wrap(aes(facets = Part)) +
  geom_point(data = by_block_cycle_means, stat = "identity", size = 5, alpha = .6) +
  ylim(250, 500)
```

This plot shows the raw data: The x-axis has the trial-number by block with RT on the y-axis and we have the three blocks separate. The colors show the different kinds of trials. 

```{r visualize raw RT}
ggplot(test_dats, aes(x = trial_by_block, y = Stim.RT, colour = Primetype, group = Primetype)) + 
  geom_point(size = 0.1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_wrap(facet = "Running") + 
  geom_smooth(method = "lm")
```

### Differences between food types

Now let's check the pre-registered hypothesis about reaction times to high- vs low-caloric foods at baseline.

```{r RTdiffBaseline}
### paired t-test to compare the different kinds of stimulus
dat_t_test <- NA
dat_t_test$High_Balanced <- (as.numeric(full_withERP$High_Balanced_1) + 
                               as.numeric(full_withERP$High_Balanced_2) +
                               as.numeric(full_withERP$High_Balanced_3) +
                               as.numeric(full_withERP$High_Balanced_4))/4
dat_t_test$Low_Balanced <- (as.numeric(full_withERP$Low_Balanced_1) + 
                              as.numeric(full_withERP$Low_Balanced_2) +
                              as.numeric(full_withERP$Low_Balanced_3) +
                              as.numeric(full_withERP$Low_Balanced_4))/4
dat_t_test <- as.data.frame(dat_t_test)
t.test(dat_t_test$High_Balanced, dat_t_test$Low_Balanced, paired = TRUE, alternative = "less")
```

And this is Cohen's _d_ for this comparison.

```{r}
lsr::cohensD(dat_t_test$High_Balanced, dat_t_test$Low_Balanced)
```

There's no significant difference between reaction times towards the two types of food images. 

Of course, we can also check for this in the biased blocks, using the respective dominant Go-trials.

```{r RTdiffBias}
### paired t-test to compare the different kinds of stimulus
dat_t_test <- NA
dat_t_test$High_Balanced <- (as.numeric(full_withERP$High_HighGo_1) + 
                               as.numeric(full_withERP$High_HighGo_2) +
                               as.numeric(full_withERP$High_HighGo_3) +
                               as.numeric(full_withERP$High_HighGo_4))/4
dat_t_test$Low_Balanced <- (as.numeric(full_withERP$Low_LowGo_1) + 
                              as.numeric(full_withERP$Low_LowGo_2) +
                              as.numeric(full_withERP$Low_LowGo_3) +
                              as.numeric(full_withERP$Low_LowGo_4))/4
dat_t_test <- as.data.frame(dat_t_test)
t.test(dat_t_test$High_Balanced, dat_t_test$Low_Balanced, paired = TRUE, alternative = "less")
```

And again Cohen's _d_.

```{r}
lsr::cohensD(dat_t_test$High_Balanced, dat_t_test$Low_Balanced)
```

Also here in the biased blocks, we see no difference between the two food types.

### Using RT-bias to predict food intake

Here we test how well the RT-bias, i.e. the difference in reaction times between food types, predicts food intake, in- and outside the laboratory.

```{r}
# We first need to construct an RT-bias variable
full_withERP$baseline_high_go <- (full_withERP$High_Balanced_1 + full_withERP$High_Balanced_2 +
                                full_withERP$High_Balanced_3 + full_withERP$High_Balanced_4)/4
full_withERP$baseline_low_go <- (full_withERP$Low_Balanced_1 + full_withERP$Low_Balanced_2 +
                                full_withERP$Low_Balanced_3 + full_withERP$Low_Balanced_4)/4
full_withERP$baseline_RTbias <- full_withERP$baseline_high_go - full_withERP$baseline_low_go
```

```{r, results="asis"}
## Let's do a regression with High-Cal-Go RT minus Low-Cal-Go RT at baseline (baseline_RTbias) 
## predicting food intake

reg_RT_diary <- lm(Daily_intake ~ baseline_RTbias + as.numeric(Age) + Sex + BMI,
           data = full_withERP)
## And for lab food intake
reg_RT_lab <- lm(total_in_lab ~ baseline_RTbias + as.numeric(Age) + Sex + BMI, 
           data = full_withERP)
### Both regression coefficients are not significant
stargazer::stargazer(reg_RT_diary, reg_RT_lab, digits = 2, type = "html", star.cutoffs = c(0.05, 0.01, 0.001))
```

This analysis shows no significant predictive value for food intake (inside the lab or outside) of the RT-differences between high-and low-calorie images.

### Error rates

Overall, we found very small error rates - it seems the task was fairly easy. Let's take a look.
```{r}
test_dats_raw %>%
  subset(., Running == "TrialListTestBalanced" | 
           Running == "TrialListHighCalGo" | 
           Running == "TrialListLowCalGo") %>%
  group_by(Running) %>%
  summarise_at(., vars(commission, ommission), funs(mean, sd))
```



## Laboratory food intake

Here is a graph to illustrate how much people ate at the two occasions and how it changed from T1 to T2 for the individuals.

```{r}
lab_intake_time <- dplyr::select(full_withERP,
                     Subject,
                     consumed_T1, 
                     consumed_T2) %>%
  gather("timepoint", "amount", -Subject)
mean_lab_intake_time <- lab_intake_time %>%
  group_by(timepoint) %>%
  summarise_at(., "amount", funs(amount = mean))
ggplot(lab_intake_time, aes(timepoint, amount, group = Subject, color = Subject)) + 
  geom_point(alpha = 0.3) +
  geom_line(stat = "identity")
```

We might expect that the effect of the training worked only at the first timepoint because participants were then saturated at T2. To test for this, we conduct an independent samples t-test with the training block conducted _first_ as the independent variable and candy consumption at T1 as the outcome.

```{r, results="asis"}
food_time_points <- lm(consumed_T1 ~ Order, data = full_withERP)
stargazer::stargazer(food_time_points, type = "html", star.cutoffs = c(0.05, 0.01, 0.001), report = "vc*sp")
# To get descriptives:
full_withERP %>% 
  group_by(Order) %>%
  summarize_at(., "consumed_T1", funs(mean, sd))
```

We see that this is not the case. Note, however, that we only have 25 people in each group here since we analyse it as a between-subjects design, so power is probably really low.

## Regressions for food intake by electrode

In the manuscript, we used an average of all electrode sites for the prediction of food intake. Here, I present additionally separate regression models for the 4 electrode sites of interest. But we see that at none of the electrode sites is there a significant effect.

```{r, results="asis"}
# For Cz
## Regression for diary intake
model1 <- lm(Daily_intake ~ BaselineDiff_Cz + as.numeric(Age) + Sex + BMI + overall_hunger, data = subset(full_withERP, Daily_intake_outlier == "0"))

## And for lab food intake
model2 <- lm(total_in_lab ~ BaselineDiff_Cz + as.numeric(Age) + Sex + BMI + overall_hunger, data = full_withERP)

# For FC1
## Regression for diary intake
model3 <- lm(Daily_intake ~ BaselineDiff_FC1 + as.numeric(Age) + Sex + BMI + overall_hunger, data = subset(full_withERP, Daily_intake_outlier == "0"))

## And for lab food intake
model4 <- lm(total_in_lab ~ BaselineDiff_FC1 + as.numeric(Age) + Sex + BMI + overall_hunger, data = full_withERP)

# For FC2
## Regression for diary intake
model5 <- lm(Daily_intake ~ BaselineDiff_FC2 + as.numeric(Age) + Sex + BMI + overall_hunger, data = subset(full_withERP, Daily_intake_outlier == "0"))

## And for lab food intake
model6 <- lm(total_in_lab ~ BaselineDiff_FC2 + as.numeric(Age) + Sex + BMI + overall_hunger, data = full_withERP)

# For Fz
## Regression for diary intake
model7 <- lm(Daily_intake ~ BaselineDiff_Fz + as.numeric(Age) + Sex + BMI + overall_hunger, data = subset(full_withERP, Daily_intake_outlier == "0"))

## And for lab food intake
model8 <- lm(total_in_lab ~ BaselineDiff_Fz + as.numeric(Age) + Sex + BMI + overall_hunger, data = full_withERP)


stargazer::stargazer(model1, model2, model3, model4, model5, model6, model7, model8, type = "html", digits = 2, star.cutoffs = c(0.05, 0.01, 0.001), report = "vc*sp")
```

So we see that there is no significant relation at an alpha-level of .05 between food intake and the bias scores, no matter where the ERP was recorded.

## ERPs for non-dominant trials

In all analyses, we only used dominant trials in the biased blocks. However, we also have the rare trials which are included in the following graph. We see all four trial types in the training blocks with the Low-Calorie-No-Go block on the left and the High-Calorie-No-Go block on the right. It is important to note, however, that these estimates are not very reliable as they come from very few trials.

```{r}
Bias_Cycles_withrares <- full_withERP %>%
  dplyr::select(pp,
                HighGo_1_HighCalGo.allsites, HighGo_2_HighCalGo.allsites,
                HighNo_1_LowCalGo.allsites, HighNo_2_LowCalGo.allsites,
                LowGo_1_LowCalGo.allsites, LowGo_2_LowCalGo.allsites,
                LowNo_1_HighCalGo.allsites, LowNo_2_HighCalGo.allsites,
                HighGo_1_LowCalGo.allsites, HighGo_2_LowCalGo.allsites,
                HighNo_1_HighCalGo.allsites, HighNo_2_HighCalGo.allsites,
                LowGo_1_HighCalGo.allsites, LowGo_2_HighCalGo.allsites,
                LowNo_1_LowCalGo.allsites, LowNo_2_LowCalGo.allsites) %>%
  gather("Trial_Cycle_Block", "N2", HighGo_1_HighCalGo.allsites:LowNo_2_LowCalGo.allsites) %>%
  separate(col = Trial_Cycle_Block, into = c("Trial", "Timepoint", "Block"), sep = "_") %>%
  separate(col = "Trial", into = c("HighLow", "GoNo"), sep = -2, remove = FALSE) %>%
  mutate(Block = as.factor(Block)) %>%
  mutate(Block = recode(Block, HighCalGo.allsites = "Low-Calorie-No-Go", LowCalGo.allsites = "High-Calorie-No-Go"))
  
Bias_Cycles_withrares_means <- Bias_Cycles_withrares %>% 
  group_by(HighLow, GoNo, Timepoint, Block) %>%
  summarise_at(., vars(N2), funs(mean))

ggplot(Bias_Cycles_withrares, aes(x = Timepoint, y = N2, color = GoNo, shape = HighLow)) +
  geom_point(alpha = 0.3) +
  facet_wrap(facet = "Block") +
  geom_point(data = Bias_Cycles_withrares_means, stat = "identity", size = 5, alpha = .6) +
  scale_colour_manual(values = c("#009E73", "#D55E00"))
```

## ERP change predicting food intake

To investigate whether _change_ in N2-bias during the training predicts food intake, we run a regression for this. So we create a variable indicating the change in N2-bias from Cycle 1 to Cycle 2 in the training blocks (an indidvidual "training score" if you will). Then we use that score as a predictor for food intake _after that block_.

```{r}
full_withERP$N2_bias_change_LowCalGo_Cz <- (full_withERP$LowCalGo_DiffCz_1 - full_withERP$LowCalGo_DiffCz_2)
full_withERP$N2_bias_change_HighCalGo_Cz <- (full_withERP$HighCalGo_DiffCz_1 - full_withERP$HighCalGo_DiffCz_2)
full_withERP$N2_bias_change_LowCalGo_FC1 <- (full_withERP$LowCalGo_DiffFC1_1 - full_withERP$LowCalGo_DiffFC1_2)
full_withERP$N2_bias_change_HighCalGo_FC1 <- (full_withERP$HighCalGo_DiffFC1_1 - full_withERP$HighCalGo_DiffFC1_2)
full_withERP$N2_bias_change_LowCalGo_FC2 <- (full_withERP$LowCalGo_DiffFC2_1 - full_withERP$LowCalGo_DiffFC2_2)
full_withERP$N2_bias_change_HighCalGo_FC2 <- (full_withERP$HighCalGo_DiffFC2_1 - full_withERP$HighCalGo_DiffFC2_2)
full_withERP$N2_bias_change_LowCalGo_Fz <- (full_withERP$LowCalGo_DiffFz_1 - full_withERP$LowCalGo_DiffFz_2)
full_withERP$N2_bias_change_HighCalGo_Fz <- (full_withERP$HighCalGo_DiffFz_1 - full_withERP$HighCalGo_DiffFz_2)
# And create a mean value across electrode sites
full_withERP$N2_bias_change_LowCalGo <- 
  rowMeans(full_withERP[c("N2_bias_change_LowCalGo_Cz", "N2_bias_change_LowCalGo_FC1", "N2_bias_change_LowCalGo_FC2", "N2_bias_change_LowCalGo_Fz")])
full_withERP$N2_bias_change_HighCalGo <- 
  rowMeans(full_withERP[c("N2_bias_change_HighCalGo_Cz", "N2_bias_change_HighCalGo_FC1", "N2_bias_change_HighCalGo_FC2", "N2_bias_change_HighCalGo_Fz")])
```

```{r}
# For the learning scores in the LowCalGo block
LowCalGo_change_reg <- lm(after_Low_Cal_Go ~ N2_bias_change_LowCalGo, data = full_withERP)
# For the learning scores in the HighCalGo block
HighCalGo_change_reg <- lm(after_High_Cal_Go ~ N2_bias_change_HighCalGo, data = full_withERP)
```
```{r, results = "asis"}
stargazer::stargazer(LowCalGo_change_reg, HighCalGo_change_reg, type = "html", digits = 2, star.cutoffs = c(0.05, 0.01, 0.001), report = "vc*sp")
``` 

So apparently this "training score" has no effect on food intake in the laboratory.

## Food liking

Here is a simple summary table for the average food liking ratings.

```{r, echo=FALSE}
# Out of curiosity, we can check the evaluations of different food items
food_evals <- test_dats_raw %>% 
  filter(!is.na(FoodEvalItems.RESP)) %>%
  group_by(FoodPic) %>%
  summarize(mean = mean(FoodEvalItems.RESP), sd = sd(FoodEvalItems.RESP))
food_evals$FoodPic <- food_evals$FoodPic %>%
  gsub(pattern = "img/FOOD/0", replacement = "")
food_evals$FoodPic <- as.factor(food_evals$FoodPic) 
food_evals %>%  mutate(FoodPic = dplyr::recode(FoodPic, "01" = "Croissant basket",
                                                 "02" = "Waffle",
                                                 "03" = "Croissants",
                                                 "04" = "Chips bag",
                                                 "05" = "Marble Cake",
                                                 "06" = "Chocolate Donut",
                                                 "07" = "Chocolate wrapped",
                                                 "08" = "Cake piece",
                                                 "09" = "Crackers",
                                                 "10" = "Chocolate marshmallows",
                                                 "11" = "Chocolate biscuits",
                                                 "12" = "Chocolate with nuts",
                                                 "13" = "Chocolate biscuits",
                                                 "14" = "Chocolate whole",
                                                 "15" = "Chocolate bar",
                                                 "16" = "KitKat",
                                                 "17" = "M and Ms",
                                                 "18" = "Oreo",
                                                 "19" = "Croissant",
                                                 "20" = "Chocolate caramel bar",
                                                 "21" = "Tomatoes whole",
                                                 "22" = "Bell peppers",
                                                 "23" = "Water melon",
                                                 "24" = "Different vegetables",
                                                 "25" = "Strawberries",
                                                 "26" = "Oranges",
                                                 "27" = "Cauliflower",
                                                 "28" = "Broccoli",
                                                 "29" = "Cucumbers",
                                                 "30" = "Blood oranges",
                                                 "31" = "Aspargus",
                                                 "32" = "Champignons",
                                                 "33" = "Cucumber sliced",
                                                 "34" = "Tomatoes",
                                                 "35" = "Pineapple",
                                                 "36" = "Carrots",
                                                 "37" = "Peas",
                                                 "38" = "Zucchini",
                                                 "39" = "Guantaloupe melon",
                                                 "40" = "Bell pepper sliced"))
```
